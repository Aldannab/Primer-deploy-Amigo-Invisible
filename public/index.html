<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>ğŸ„ Amigo Invisible 2025</title>
    <link rel="stylesheet" href="./style.css">
</head>



<body>

    <div id="app"></div>

    <script>
        let CONFIG = { participantes: [], misiones: [] };

        // ========================
        // REGLAS DE EXCLUSIÃ“N
        // ========================
        // Personas que NO pueden recibir a ciertos participantes
        const EXCLUSIONES = {
            // Mock: estas personas NO pueden recibir "Felipe"
            "Felipe": ["Persona1", "Persona2"] // TODO: Modificar con los nombres reales
        };

        // ========================
        // SUPABASE BACKEND REAL
        // ========================

        const SUPABASE_URL = "https://ruslvezwludgidivyajq.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1c2x2ZXp3bHVkZ2lkaXZ5YWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDQyOTIsImV4cCI6MjA4MDUyMDI5Mn0.H4Hsnf4j4yQ80DtX4R6nypFaQ0Rgkx9sc4i6b7xnADo";

        async function cargarDesdeServidor() {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`
                }
            });

            const data = await res.json();
            CONFIG.participantes = data[0]?.participantes || [];
            CONFIG.misiones = data[0]?.misiones || [];
        }

        async function guardarParticipantesEnServidor() {
            await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                method: "PATCH",
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ participantes: CONFIG.participantes })
            });
        }

        async function guardarMisionesEnServidor() {
            await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                method: "PATCH",
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ misiones: CONFIG.misiones })
            });
        }

        // ========================
        // TOKEN
        // ========================

        function codificarToken(nombre, amigoInvisible, mision) {
            return btoa(encodeURIComponent(JSON.stringify({ n: nombre, a: amigoInvisible, m: mision })));
        }

        function decodificarToken(token) {
            try {
                const json = decodeURIComponent(atob(token));
                return JSON.parse(json);
            } catch {
                return null;
            }
        }

        // ========================
        // LÃ“GICA
        // ========================

        function realizarSorteo() {
            const participantes = [...CONFIG.participantes];
            const disponibles = [...participantes];
            const asignaciones = [];

            participantes.forEach(p => {
                // Filtrar opciones: no puede ser Ã©l mismo y respetar exclusiones
                const opciones = disponibles.filter(x => {
                    if (x === p) return false; // No puede ser Ã©l mismo
                    
                    // Verificar exclusiones: si esta persona (p) estÃ¡ en la lista de exclusiones de x
                    for (const [personaExcluida, personasQueNoPuedenRecibirla] of Object.entries(EXCLUSIONES)) {
                        if (x === personaExcluida && personasQueNoPuedenRecibirla.includes(p)) {
                            return false; // Esta persona no puede recibir a x
                        }
                    }
                    
                    return true;
                });

                if (opciones.length === 0) {
                    // Si no hay opciones vÃ¡lidas, reintentar el sorteo completo
                    console.warn("No hay opciones vÃ¡lidas, reintentando sorteo...");
                    return realizarSorteo();
                }

                const elegido = opciones[Math.floor(Math.random() * opciones.length)];
                asignaciones.push(elegido);
                disponibles.splice(disponibles.indexOf(elegido), 1);
            });

            return asignaciones;
        }

        function asignarMisiones() {
            return CONFIG.participantes.map(() => {
                const i = Math.floor(Math.random() * CONFIG.misiones.length);
                return CONFIG.misiones[i];
            });
        }

        // ========================
        // UI
        // ========================

        function renderAdmin() {
            const app = document.getElementById("app");
            app.innerHTML = `
            <h2>ğŸ‘¥ Participantes</h2>
            <textarea id="participantes" rows="8" style="width: 100%">${CONFIG.participantes.join("\n")}</textarea>
            <button onclick="guardarParticipantes()">Guardar</button>

            <div class="h2-with-btn">
                <h2>ğŸ¯ Misiones</h2>
                <button class="btn-toggle-blur" onclick="toggleMisionesBlur()">ğŸ‘ï¸ Ver Misiones</button>
            </div>
            <textarea id="misiones" rows="8" class="missions-textarea blurred" style="width: 100%">${CONFIG.misiones.join("\n")}</textarea>
            <button onclick="guardarMisiones()">Guardar</button>

            <h2>ğŸ² Generar Sorteo</h2>
            <button onclick="generarEnlaces()">Generar Enlaces</button>
            <div id="links"></div>
            `;
        }

        function toggleMisionesBlur() {
            const textarea = document.getElementById("misiones");
            const btn = document.querySelector(".btn-toggle-blur");

            if (textarea.classList.contains("blurred")) {
                textarea.classList.remove("blurred");
                btn.textContent = "ğŸ”’ Ocultar Misiones";
            } else {
                textarea.classList.add("blurred");
                btn.textContent = "ğŸ‘ï¸ Ver Misiones";
            }
        }

        function renderParticipante(token) {
            const data = decodificarToken(token);
            const app = document.getElementById("app");

            if (!data) {
                app.innerHTML = "<h2>Enlace invÃ¡lido</h2>";
                return;
            }

            app.innerHTML = `
                <div class="participant-view">
                    <div class="greeting">
                        <h1>Â¡Hola ${data.n}! ğŸ‘‹</h1>
                    </div>

                    <div class="result-card">
                        <div class="result-label">Tu amigo invisible es:</div>
                        <div class="result-name">${data.a}</div>
                    </div>

                    <div class="mission-card">
                        <div class="mission-label">Tu misiÃ³n:</div>
                        <div class="mission-text">${data.m}</div>
                        <div class="mission-hint">ğŸ¤« Â¡ALERTA DE MISIÃ“N SECRETA! ğŸ•µï¸â€â™€ï¸ Para ganar un premio debes completar la misiÃ³n antes de las 00:00 HS y no ser descubierto.</div>
                    </div>
                </div>
            `;
        }

        // ========================
        // ACCIONES
        // ========================

        async function guardarParticipantes() {
            const input = document.getElementById("participantes").value;
            CONFIG.participantes = input.split("\n").map(x => x.trim()).filter(Boolean);
            await guardarParticipantesEnServidor();
            alert("Participantes guardados");
        }

        async function guardarMisiones() {
            const input = document.getElementById("misiones").value;
            CONFIG.misiones = input.split("\n").map(x => x.trim()).filter(Boolean);
            await guardarMisionesEnServidor();
            alert("Misiones guardadas");
        }

        function generarEnlaces() {
            const asignaciones = realizarSorteo();
            const misiones = asignarMisiones();

            const resultados = CONFIG.participantes.map((p, i) => ({
                nombre: p,
                amigo: asignaciones[i],
                mision: misiones[i],
                token: codificarToken(p, asignaciones[i], misiones[i])
            }));

            const base = location.origin + location.pathname;
            const div = document.getElementById("links");

            div.innerHTML = `
                <div class="links-container">
                    <h3>ğŸ“§ Enlaces de Acceso</h3>
                    <div class="links-list">
                        ${resultados.map((r, idx) => `
                            <div class="link-card">
                                <div class="link-number">${idx + 1}</div>
                                <div class="link-details">
                                    <div class="link-name">ğŸ‘¤ ${r.nombre}</div>
                                    <div class="link-url">
                                        <code>${base}?token=${r.token}</code>
                                    </div>
                                    <button class="btn-copy" onclick="copiarAlPortapapeles('${base}?token=${r.token}')">ğŸ“‹ Copiar</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-export" onclick="exportarEnlaces('${base}', ${JSON.stringify(resultados)})">ğŸ’¾ Exportar todos</button>
                </div>
            `;
        }

        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                alert("Enlace copiado al portapapeles");
            });
        }

        function exportarEnlaces(base, resultados) {
            let contenido = "Enlaces del Amigo Invisible 2025\n";
            contenido += "================================\n\n";
            resultados.forEach((r, idx) => {
                contenido += `${idx + 1}. ${r.nombre}\n`;
                contenido += `${base}?token=${r.token}\n\n`;
            });

            const blob = new Blob([contenido], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "enlaces-amigo-invisible.txt";
            a.click();
        }

        // ========================
        // INIT
        // ========================

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get("token");

            if (token) {
                renderParticipante(token);
            } else {
                await cargarDesdeServidor();
                renderAdmin();
            }
        }

        init();

        const emojis = ["ğŸ„", "â„ï¸", "ğŸ…", "ğŸ", "â­", "â˜ƒï¸"];

        function crearEmoji() {
            const snow = document.createElement("div");
            snow.classList.add("snow");
            snow.innerText = emojis[Math.floor(Math.random() * emojis.length)];

            snow.style.left = Math.random() * 100 + "vw";
            snow.style.animationDuration = 5 + Math.random() * 5 + "s";
            snow.style.fontSize = 18 + Math.random() * 20 + "px";

            document.body.appendChild(snow);

            setTimeout(() => {
                snow.remove();
            }, 11000);
        }

        setInterval(crearEmoji, 350);
    </script>

</body>

</html>