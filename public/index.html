<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>üéÑ Amigo Invisible 2025</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>

    <div id="app"></div>

    <script>
        let CONFIG = { participantes: [], misiones: [] };

        const EXCLUSIONES = {
            "Feli": ["Romi", "Lu", "Gabi", "Juli", "Santi", "Tobi", "Aldi"]
        };

        const SUPABASE_URL = "https://ruslvezwludgidivyajq.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1c2x2ZXp3bHVkZ2lkaXZ5YWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDQyOTIsImV4cCI6MjA4MDUyMDI5Mn0.H4Hsnf4j4yQ80DtX4R6nypFaQ0Rgkx9sc4i6b7xnADo";

        async function cargarDesdeServidor() {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`
                }
            });

            const data = await res.json();
            CONFIG.participantes = data[0]?.participantes || [];
            CONFIG.misiones = data[0]?.misiones || [];
        }

        async function guardarParticipantesEnServidor() {
            await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                method: "PATCH",
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ participantes: CONFIG.participantes })
            });
        }

        async function guardarMisionesEnServidor() {
            await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                method: "PATCH",
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ misiones: CONFIG.misiones })
            });
        }

        function codificarToken(nombre, amigoInvisible, mision) {
            return btoa(encodeURIComponent(JSON.stringify({ n: nombre, a: amigoInvisible, m: mision })));
        }

        function decodificarToken(token) {
            try {
                const json = decodeURIComponent(atob(token));
                return JSON.parse(json);
            } catch {
                return null;
            }
        }

        function puedeRecibir(participante, candidato) {
            if (participante === candidato) return false;
            for (const [personaExcluida, personasQueNoPuedenRecibirla] of Object.entries(EXCLUSIONES)) {
                if (candidato === personaExcluida && personasQueNoPuedenRecibirla.includes(participante)) {
                    return false;
                }
            }
            return true;
        }

        function realizarSorteo() {
            const participantes = [...CONFIG.participantes];
            const maxIntentos = 1000;
            
            for (let intento = 0; intento < maxIntentos; intento++) {
                const disponibles = [...participantes];
                const asignaciones = [];
                let sorteoValido = true;

                for (let i = participantes.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [disponibles[i], disponibles[j]] = [disponibles[j], disponibles[i]];
                }

                for (let i = 0; i < participantes.length; i++) {
                    const opciones = disponibles.filter(c => puedeRecibir(participantes[i], c));
                    if (opciones.length === 0) {
                        sorteoValido = false;
                        break;
                    }
                    const elegido = opciones[Math.floor(Math.random() * opciones.length)];
                    asignaciones.push(elegido);
                    disponibles.splice(disponibles.indexOf(elegido), 1);
                }

                if (sorteoValido && asignaciones.length === participantes.length) {
                    const todosValidos = asignaciones.every((a, i) => 
                        a && a !== participantes[i] && puedeRecibir(participantes[i], a)
                    );
                    if (todosValidos) return asignaciones;
                }
            }

            console.error("No se pudo realizar un sorteo v√°lido");
            alert("Error: No se pudo realizar el sorteo. Revisa las reglas de exclusi√≥n.");
            return null;
        }

        function asignarMisiones() {
            if (CONFIG.misiones.length < CONFIG.participantes.length) {
                return null; // No hay suficientes misiones
            }
            
            const misionesDisponibles = [...CONFIG.misiones];
            const misionesAsignadas = [];
            
            // Mezclar aleatoriamente
            for (let i = misionesDisponibles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [misionesDisponibles[i], misionesDisponibles[j]] = [misionesDisponibles[j], misionesDisponibles[i]];
            }
            
            // Asignar una misi√≥n √∫nica a cada participante
            for (let i = 0; i < CONFIG.participantes.length; i++) {
                misionesAsignadas.push(misionesDisponibles[i]);
            }
            
            return misionesAsignadas;
        }

        function renderAdmin() {
            const app = document.getElementById("app");
            app.innerHTML = `
            <h2>üë• Participantes</h2>
            <textarea id="participantes" rows="8" style="width: 100%">${CONFIG.participantes.join("\n")}</textarea>
            <button onclick="guardarParticipantes()">Guardar</button>

            <div class="h2-with-btn">
                <h2>üéØ Misiones</h2>
                <button class="btn-toggle-blur" onclick="toggleMisionesBlur()">üëÅÔ∏è Ver Misiones</button>
            </div>
            <textarea id="misiones" rows="8" class="missions-textarea blurred" style="width: 100%">${CONFIG.misiones.join("\n")}</textarea>
            <button onclick="guardarMisiones()">Guardar</button>

            <h2>üé≤ Generar Sorteo</h2>
            <button onclick="generarEnlaces()">Generar Enlaces</button>
            <div id="links"></div>
            `;
        }

        function toggleMisionesBlur() {
            const textarea = document.getElementById("misiones");
            const btn = document.querySelector(".btn-toggle-blur");

            if (textarea.classList.contains("blurred")) {
                textarea.classList.remove("blurred");
                btn.textContent = "üîí Ocultar Misiones";
            } else {
                textarea.classList.add("blurred");
                btn.textContent = "üëÅÔ∏è Ver Misiones";
            }
        }

        function renderParticipante(token) {
            const data = decodificarToken(token);
            const app = document.getElementById("app");

            if (!data) {
                app.innerHTML = "<h2>Enlace inv√°lido</h2>";
                return;
            }

            app.innerHTML = `
                <div class="participant-view">
                    <div class="greeting">
                        <h1>¬°Hola ${data.n}! üëã</h1>
                    </div>

                    <div class="result-card">
                        <div class="result-label">Tu amigo invisible es:</div>
                        <div class="result-name">${data.a}</div>
                    </div>

                    <div class="mission-card">
                        <div class="mission-label">Tu misi√≥n:</div>
                        <div class="mission-text">${data.m}</div>
                        <div class="mission-hint">ü§´ ¬°ALERTA DE MISI√ìN SECRETA! üïµÔ∏è‚Äç‚ôÄÔ∏è Para ganar un premio debes completar la misi√≥n antes de las 00:00 HS y no ser descubierto.</div>
                    </div>
                </div>
            `;
        }

        async function guardarParticipantes() {
            const input = document.getElementById("participantes").value;
            CONFIG.participantes = input.split("\n").map(x => x.trim()).filter(Boolean);
            
            if (CONFIG.participantes.length === 0) {
                alert("‚ö†Ô∏è No hay participantes para guardar");
                return;
            }
            
            try {
                await guardarParticipantesEnServidor();
                alert(`‚úÖ Participantes guardados: ${CONFIG.participantes.length} participantes`);
            } catch (error) {
                console.error("Error al guardar participantes:", error);
                alert("‚ùå Error al guardar participantes. Revisa la consola.");
            }
        }

        async function guardarMisiones() {
            const input = document.getElementById("misiones").value;
            CONFIG.misiones = input.split("\n").map(x => x.trim()).filter(Boolean);
            
            if (CONFIG.misiones.length === 0) {
                alert("‚ö†Ô∏è No hay misiones para guardar");
                return;
            }
            
            try {
                await guardarMisionesEnServidor();
                alert(`‚úÖ Misiones guardadas: ${CONFIG.misiones.length} misiones`);
            } catch (error) {
                console.error("Error al guardar misiones:", error);
                alert("‚ùå Error al guardar misiones. Revisa la consola.");
            }
        }

        function generarEnlaces() {
            if (CONFIG.misiones.length < CONFIG.participantes.length) {
                alert(`Error: Necesitas al menos ${CONFIG.participantes.length} misiones (tienes ${CONFIG.misiones.length}). Cada persona debe tener una misi√≥n √∫nica.`);
                return;
            }
            
            const asignaciones = realizarSorteo();
            if (!asignaciones || asignaciones.length !== CONFIG.participantes.length) return;
            
            const misiones = asignarMisiones();
            if (!misiones || misiones.length !== CONFIG.participantes.length) {
                alert("Error: No se pudieron asignar misiones √∫nicas. Verifica que tengas suficientes misiones.");
                return;
            }

            const resultados = CONFIG.participantes.map((p, i) => ({
                nombre: p,
                amigo: asignaciones[i],
                mision: misiones[i],
                token: codificarToken(p, asignaciones[i], misiones[i])
            }));

            const base = location.origin + location.pathname;
            const div = document.getElementById("links");

            div.innerHTML = `
                <div class="links-container">
                    <h3>üìß Enlaces de Acceso</h3>
                    <div class="links-list">
                        ${resultados.map((r, idx) => `
                            <div class="link-card">
                                <div class="link-number">${idx + 1}</div>
                                <div class="link-details">
                                    <div class="link-name">üë§ ${r.nombre}</div>
                                    <div class="link-url">
                                        <code>${base}?token=${r.token}</code>
                                    </div>
                                    <button class="btn-copy" onclick="copiarAlPortapapeles('${base}?token=${r.token}')">üìã Copiar</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-export" onclick="exportarEnlaces('${base}', ${JSON.stringify(resultados)})">üíæ Exportar todos</button>
                </div>
            `;
        }

        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                alert("Enlace copiado al portapapeles");
            });
        }

        function exportarEnlaces(base, resultados) {
            let contenido = "Enlaces del Amigo Invisible 2025\n";
            contenido += "================================\n\n";
            resultados.forEach((r, idx) => {
                contenido += `${idx + 1}. ${r.nombre}\n`;
                contenido += `${base}?token=${r.token}\n\n`;
            });

            const blob = new Blob([contenido], { type: "text/plain" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "enlaces-amigo-invisible.txt";
            a.click();
        }

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get("token");
            const test = params.get("test");

            if (token) {
                renderParticipante(token);
            } else {
                await cargarDesdeServidor();
                renderAdmin();
                
                if (test || window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.log("üß™ Ejecutando tests...");
                    console.log("Participantes cargados:", CONFIG.participantes.length);
                    
                    if (CONFIG.participantes.length === 0) {
                        console.warn("‚ö†Ô∏è No hay participantes cargados. Carga participantes primero.");
                    } else if (CONFIG.misiones.length < CONFIG.participantes.length) {
                        console.warn(`‚ö†Ô∏è No hay suficientes misiones. Necesitas ${CONFIG.participantes.length}, tienes ${CONFIG.misiones.length}.`);
                    } else {
                        const asignaciones = realizarSorteo();
                        if (!asignaciones) {
                            console.error("‚ùå FALLO: No se pudo realizar el sorteo");
                        } else {
                            const misiones = asignarMisiones();
                            if (!misiones) {
                                console.error("‚ùå FALLO: No se pudieron asignar misiones");
                            } else {
                                const okSorteo = !asignaciones.some(a => !a || a === undefined) &&
                                               asignaciones.length === CONFIG.participantes.length &&
                                               !asignaciones.some((a, i) => a === CONFIG.participantes[i]) &&
                                               new Set(asignaciones).size === asignaciones.length;
                                
                                const okMisiones = misiones.length === CONFIG.participantes.length &&
                                                   new Set(misiones).size === misiones.length;
                                
                                const ok = okSorteo && okMisiones;
                                
                                console.log(ok ? "‚úÖ Tests OK" : "‚ùå Tests FALLARON");
                                console.log("  Sorteo:", okSorteo ? "‚úÖ" : "‚ùå");
                                console.log("  Misiones √∫nicas:", okMisiones ? "‚úÖ" : "‚ùå");
                                console.log("Asignaciones:", asignaciones);
                                console.log("Misiones:", misiones);
                            }
                        }
                    }
                }
            }
        }

        init();

        const emojis = ["üéÑ", "‚ùÑÔ∏è", "üéÖ", "üéÅ", "‚≠ê", "‚òÉÔ∏è"];

        function crearEmoji() {
            const snow = document.createElement("div");
            snow.classList.add("snow");
            snow.innerText = emojis[Math.floor(Math.random() * emojis.length)];

            snow.style.left = Math.random() * 100 + "vw";
            snow.style.animationDuration = 5 + Math.random() * 5 + "s";
            snow.style.fontSize = 18 + Math.random() * 20 + "px";

            document.body.appendChild(snow);

            setTimeout(() => {
                snow.remove();
            }, 11000);
        }

        setInterval(crearEmoji, 350);
    </script>
</body>
</html>