<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>ðŸŽ„ Amigo Invisible 2025</title>
</head>

<body>

    <div id="app"></div>

    <script>
        let CONFIG = { participantes: [], misiones: [] };

        // ========================
        // SUPABASE BACKEND REAL
        // ========================

        const SUPABASE_URL = "https://ruslvezwludgidivyajq.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ1c2x2ZXp3bHVkZ2lkaXZ5YWpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDQyOTIsImV4cCI6MjA4MDUyMDI5Mn0.H4Hsnf4j4yQ80DtX4R6nypFaQ0Rgkx9sc4i6b7xnADo";

        async function cargarDesdeServidor() {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`
                }
            });

            const data = await res.json();
            CONFIG.participantes = data[0]?.participantes || [];
            CONFIG.misiones = data[0]?.misiones || [];
        }

        async function guardarParticipantesEnServidor() {
            await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                method: "PATCH",
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ participantes: CONFIG.participantes })
            });
        }

        async function guardarMisionesEnServidor() {
            await fetch(`${SUPABASE_URL}/rest/v1/data_store?id=eq.1`, {
                method: "PATCH",
                headers: {
                    apikey: SUPABASE_KEY,
                    Authorization: `Bearer ${SUPABASE_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ misiones: CONFIG.misiones })
            });
        }

        // ========================
        // TOKEN
        // ========================

        function codificarToken(nombre, amigoInvisible, mision) {
            return btoa(encodeURIComponent(JSON.stringify({ n: nombre, a: amigoInvisible, m: mision })));
        }

        function decodificarToken(token) {
            try {
                const json = decodeURIComponent(atob(token));
                return JSON.parse(json);
            } catch {
                return null;
            }
        }

        // ========================
        // LÃ“GICA
        // ========================

        function realizarSorteo() {
            const participantes = [...CONFIG.participantes];
            const disponibles = [...participantes];
            const asignaciones = [];

            participantes.forEach(p => {
                const opciones = disponibles.filter(x => x !== p);
                const elegido = opciones[Math.floor(Math.random() * opciones.length)];
                asignaciones.push(elegido);
                disponibles.splice(disponibles.indexOf(elegido), 1);
            });

            return asignaciones;
        }

        function asignarMisiones() {
            return CONFIG.participantes.map(() => {
                const i = Math.floor(Math.random() * CONFIG.misiones.length);
                return CONFIG.misiones[i];
            });
        }

        // ========================
        // UI
        // ========================

        function renderAdmin() {
            const app = document.getElementById("app");
            app.innerHTML = `
        <h2>Participantes</h2>
        <textarea id="participantes" rows="8" style="width: 100%">${CONFIG.participantes.join("\n")}</textarea>
        <button onclick="guardarParticipantes()">Guardar</button>

        <h2>Misiones</h2>
        <textarea id="misiones" rows="8" style="width: 100%">${CONFIG.misiones.join("\n")}</textarea>
        <button onclick="guardarMisiones()">Guardar</button>

        <h2>Sorteo</h2>
        <button onclick="generarEnlaces()">Generar Enlaces</button>
        <div id="links"></div>
      `;
        }

        function renderParticipante(token) {
            const data = decodificarToken(token);
            const app = document.getElementById("app");

            if (!data) {
                app.innerHTML = "<h2>Enlace invÃ¡lido</h2>";
                return;
            }

            app.innerHTML = `
        <h1>Hola ${data.n}</h1>
        <h2>Tu amigo invisible es: ${data.a}</h2>
        <h3>Tu misiÃ³n: ${data.m}</h3>
      `;
        }

        // ========================
        // ACCIONES
        // ========================

        async function guardarParticipantes() {
            const input = document.getElementById("participantes").value;
            CONFIG.participantes = input.split("\n").map(x => x.trim()).filter(Boolean);
            await guardarParticipantesEnServidor();
            alert("Participantes guardados");
        }

        async function guardarMisiones() {
            const input = document.getElementById("misiones").value;
            CONFIG.misiones = input.split("\n").map(x => x.trim()).filter(Boolean);
            await guardarMisionesEnServidor();
            alert("Misiones guardadas");
        }

        function generarEnlaces() {
            const asignaciones = realizarSorteo();
            const misiones = asignarMisiones();

            const resultados = CONFIG.participantes.map((p, i) => ({
                nombre: p,
                amigo: asignaciones[i],
                mision: misiones[i],
                token: codificarToken(p, asignaciones[i], misiones[i])
            }));

            const base = location.origin + location.pathname;
            const div = document.getElementById("links");

            div.innerHTML = resultados.map(r =>
                `<p><strong>${r.nombre}</strong>:<br>${base}?token=${r.token}</p>`
            ).join("");
        }

        // ========================
        // INIT
        // ========================

        async function init() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get("token");

            if (token) {
                renderParticipante(token);
            } else {
                await cargarDesdeServidor();
                renderAdmin();
            }
        }

        init();
    </script>

</body>

</html>